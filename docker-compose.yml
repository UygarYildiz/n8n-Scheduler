version: '3.7'

services:
  # MySQL Veritabanı Servisi
  mysql:
    image: mysql:8.0
    restart: unless-stopped
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: bitirme_root_2024
      MYSQL_DATABASE: optimization_db
      MYSQL_USER: optimization_user
      MYSQL_PASSWORD: optimization_pass_2024
      # UTF-8 sorunlarını önlemek için
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/init:/docker-entrypoint-initdb.d
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    networks:
      - optimization_network

  n8n:
    image: n8nio/n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - GENERIC_TIMEZONE=Europe/Istanbul
      # Webhook'ların dışarıdan erişilebilir olması için
      - N8N_EDITOR_BASE_URL=http://localhost:5678
      # JSON ve YAML işleme için gerekli kütüphaneleri etkinleştir
      - NODE_FUNCTION_ALLOW_EXTERNAL=js-yaml,yaml,fs-extra
    volumes:
      - ./n8n_data:/home/node/.n8n
      # Konfigürasyon dosyaları
      - ./configs:/mnt/workflow_configs
      # Kurallar için ayrı bir klasör (opsiyonel)
      - ./configs/kurallar:/configs/kurallar
      # Veri Kaynağı Eşleştirmeleri (proje dizininden relative path):
      - ./veri_kaynaklari:/mnt/workflow_data
    # user: "1000:1000" # Uncomment if you have permission issues
    depends_on:
      - mysql
    networks:
      - optimization_network

volumes:
  n8n_data: # Define the volume if not using local path mapping above
  mysql_data: # MySQL veri kalıcılığı için

networks:
  optimization_network:
    driver: bridge
